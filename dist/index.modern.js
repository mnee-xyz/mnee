import{Utils as t,LockingScript as e,OP as r,TransactionSignature as n,Hash as o,UnlockingScript as s,Transaction as i,PublicKey as a,Script as c,P2PKH as u,PrivateKey as d}from"@bsv/sdk";import*as f from"js-1sat-ord";class l{lock(n,o){let s=[];if("string"==typeof n){const e=t.fromBase58Check(n);if(0!==e.prefix[0]&&111!==e.prefix[0])throw new Error("only P2PKH is supported");s=e.data}else s=n;const i=new e;return i.writeOpCode(r.OP_DUP).writeOpCode(r.OP_HASH160).writeBin(s).writeOpCode(r.OP_EQUALVERIFY).writeOpCode(r.OP_CHECKSIGVERIFY).writeBin(o.encode(!0)).writeOpCode(r.OP_CHECKSIG),i}userUnlock(t,e="all",r=!1,i,a){return{sign:async function(c,u){var d,f,l;let p=n.SIGHASH_FORKID;"all"===e&&(p|=n.SIGHASH_ALL),"none"===e&&(p|=n.SIGHASH_NONE),"single"===e&&(p|=n.SIGHASH_SINGLE),r&&(p|=n.SIGHASH_ANYONECANPAY);const h=c.inputs[u],g=c.inputs.filter((t,e)=>e!==u),m=h.sourceTXID?h.sourceTXID:null==(d=h.sourceTransaction)?void 0:d.id("hex");if(!m)throw new Error("The input sourceTXID or sourceTransaction is required for transaction signing.");if(i||(i=null==(f=h.sourceTransaction)?void 0:f.outputs[h.sourceOutputIndex].satoshis),!i)throw new Error("The sourceSatoshis or input sourceTransaction is required for transaction signing.");if(a||(a=null==(l=h.sourceTransaction)?void 0:l.outputs[h.sourceOutputIndex].lockingScript),!a)throw new Error("The lockingScript or input sourceTransaction is required for transaction signing.");const w=n.format({sourceTXID:m,sourceOutputIndex:h.sourceOutputIndex,sourceSatoshis:i,transactionVersion:c.version,otherInputs:g,inputIndex:u,outputs:c.outputs,inputSequence:h.sequence||4294967295,subscript:a,lockTime:c.lockTime,scope:p}),v=t.sign(o.sha256(w)),I=new n(v.r,v.s,p),x=new s;return x.writeBin(I.toChecksigFormat()),x.writeBin(t.toPublicKey().encode(!0)),x},estimateLength:async function(){return 182}}}unlock(t,e,r="all",i=!1,a,c){return{sign:async function(u,d){var f,l,p;let h=n.SIGHASH_FORKID;"all"===r&&(h|=n.SIGHASH_ALL),"none"===r&&(h|=n.SIGHASH_NONE),"single"===r&&(h|=n.SIGHASH_SINGLE),i&&(h|=n.SIGHASH_ANYONECANPAY);const g=u.inputs[d],m=u.inputs.filter((t,e)=>e!==d),w=g.sourceTXID?g.sourceTXID:null==(f=g.sourceTransaction)?void 0:f.id("hex");if(!w)throw new Error("The input sourceTXID or sourceTransaction is required for transaction signing.");if(a||(a=null==(l=g.sourceTransaction)?void 0:l.outputs[g.sourceOutputIndex].satoshis),!a)throw new Error("The sourceSatoshis or input sourceTransaction is required for transaction signing.");if(c||(c=null==(p=g.sourceTransaction)?void 0:p.outputs[g.sourceOutputIndex].lockingScript),!c)throw new Error("The lockingScript or input sourceTransaction is required for transaction signing.");const v=n.format({sourceTXID:w,sourceOutputIndex:g.sourceOutputIndex,sourceSatoshis:a,transactionVersion:u.version,otherInputs:m,inputIndex:d,outputs:u.outputs,inputSequence:g.sequence||4294967295,subscript:c,lockTime:u.lockTime,scope:h}),I=t.sign(o.sha256(v)),x=new n(I.r,I.s,h),T=new s;return T.writeBin(x.toChecksigFormat()),T.writeScript(e),T},estimateLength:async function(){return 182}}}}const p=e=>{var n,s;let i;for(let n=0;n<e.chunks.length;n++){var a;const o=e.chunks[n];n>=2&&3===(null==(a=o.data)?void 0:a.length)&&"ord"==t.toUTF8(o.data)&&e.chunks[n-1].op==r.OP_IF&&e.chunks[n-2].op==r.OP_FALSE&&(i=n+1)}if(void 0===i)return;const c={file:{hash:"",size:0,type:""},fields:{}};for(let a=i;a<e.chunks.length;a+=2){var u,d;const i=e.chunks[a];if(i.op==r.OP_ENDIF)break;if(i.op>r.OP_16)return;const f=e.chunks[a+1];if(f.op>r.OP_PUSHDATA4)return;if(null!=(u=i.data)&&u.length)continue;let l=0;switch(i.op>r.OP_PUSHDATA4&&i.op<=r.OP_16?l=i.op-80:null!=(d=i.data)&&d.length&&(l=i.data[0]),l){case 0:if(c.file.size=(null==(n=f.data)?void 0:n.length)||0,null==(s=f.data)||!s.length)break;c.file.hash=t.toBase64(o.sha256(f.data)),c.file.content=f.data;break;case 1:c.file.type=Buffer.from(f.data||[]).toString()}}return c},h=e=>e.map(e=>{const n=e.chunks;for(let e=0;e<=n.length-4;e++){var o,s,i;if(n.length>e+6&&n[0+e].op===r.OP_DUP&&n[1+e].op===r.OP_HASH160&&20===(null==(o=n[2+e].data)?void 0:o.length)&&n[3+e].op===r.OP_EQUALVERIFY&&n[4+e].op===r.OP_CHECKSIGVERIFY&&33===(null==(s=n[5+e].data)?void 0:s.length)&&n[6+e].op===r.OP_CHECKSIG)return{cosigner:t.toHex(n[5+e].data||[]),address:t.toBase58Check(n[2+e].data||[],[0])};if(n[0+e].op===r.OP_DUP&&n[1+e].op===r.OP_HASH160&&20===(null==(i=n[2+e].data)?void 0:i.length)&&n[3+e].op===r.OP_EQUALVERIFY&&n[4+e].op===r.OP_CHECKSIG)return{cosigner:"",address:t.toBase58Check(n[2+e].data||[],[0])}}}),g=(e,r,n)=>{const o=e.senders.includes(r)?"send":"receive",s=e.height>0?"confirmed":"unconfirmed";if(!e.rawtx)return null;const a=t.toArray(e.rawtx,"base64"),c=t.toHex(a),u=i.fromHex(c).outputs.map(t=>t.lockingScript),d=h(u),f=u.map(p),l=d.map(t=>t.address),g=l.indexOf(n.feeAddress),m=e.senders[0];let w=0;const v=new Map;f.forEach((e,o)=>{var s;const i=null==e||null==(s=e.file)?void 0:s.content;if(!i)return;const a=t.toUTF8(i);if(!a)return;let c;try{c=JSON.parse(a)}catch(t){return void console.error("Failed to parse inscription JSON:",t)}if("bsv-20"!==c.p||c.id!==n.tokenId)return;const u=parseInt(c.amt,10);if(Number.isNaN(u))return;if(g===o&&m===r)return void(w+=u);const d=l[o],f=v.get(d)||0;v.set(d,f+u)});const I=v.get(r)||0;if("send"===o){const t=v.get(m)||0;v.set(m,t-I)}let x=[];x="receive"===o?[{address:m,amount:I}]:Array.from(v.entries()).map(([t,e])=>({address:t,amount:e})).filter(t=>t.address!==r&&t.address!==n.feeAddress&&t.amount>0);const T=x.reduce((t,e)=>t+e.amount,0);return{txid:e.txid,height:e.height,type:o,status:s,amount:T,fee:w,score:e.score,counterparties:x}};class m{constructor(t){this.mneeApiToken="92982ec1c0975f31979da515d46bae9f",this.mneeApi="https://proxy-api.mnee.net",this.gorillaPoolApi="https://ordinals.1sat.app",this.mneeConfig=void 0,t&&(this.mneeApiToken=t),this.getConfig()}async getConfig(){try{const t=await fetch(`${this.mneeApi}/v1/config?auth_token=${this.mneeApiToken}`,{method:"GET"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json();return this.mneeConfig=e,e}catch(t){return void console.error("Failed to fetch config:",t)}}toAtomicAmount(t){if(!this.mneeConfig)throw new Error("Config not fetched");return Math.round(t*10**this.mneeConfig.decimals)}fromAtomicAmount(t){if(!this.mneeConfig)throw new Error("Config not fetched");return t/10**this.mneeConfig.decimals}async createInscription(t,e,r){const n={p:"bsv-20",op:"transfer",id:r.tokenId,amt:e.toString()};return{lockingScript:f.applyInscription((new l).lock(t,a.fromString(r.approver)),{dataB64:Buffer.from(JSON.stringify(n)).toString("base64"),contentType:"application/bsv-20"}),satoshis:1}}async getUtxos(t,e=["transfer","deploy+mint"]){try{const r=await fetch(`${this.mneeApi}/v1/utxos?auth_token=${this.mneeApiToken}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([t])});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const n=await r.json();return e.length?n.filter(t=>e.includes(t.data.bsv21.op.toLowerCase())):n}catch(t){return console.error("Failed to fetch UTXOs:",t),[]}}async broadcast(t){const e=`${this.gorillaPoolApi}/v5/tx`;try{const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:Buffer.from(t.toBinary())}),n=await r.json();return r.ok?{status:"success",txid:n.txid,message:"Transaction broadcast successfully"}:{status:"error",code:r.status.toString(),description:n.error||"Unknown error"}}catch(t){return console.error("Failed to broadcast:",t),{status:"error",code:"UNKNOWN",description:t instanceof Error?t.message:"Unknown error"}}}async fetchBeef(t){const e=await fetch(`${this.gorillaPoolApi}/v5/tx/${t}/beef`);if(404===e.status)throw new Error("Transaction not found");if(200!==e.status)throw new Error(`${e.status} - Failed to fetch beef for tx ${t}`);const r=[...Buffer.from(await e.arrayBuffer())];return i.fromAtomicBEEF(r)}async getSignatures(e,r){try{const s=65;let a;switch(e.format){case"beef":a=i.fromHexBEEF(e.rawtx);break;case"ef":a=i.fromHexEF(e.rawtx);break;default:a=i.fromHex(e.rawtx)}const d=e.sigRequests.flatMap(e=>[r].map(r=>{const i=n.format({sourceTXID:e.prevTxid,sourceOutputIndex:e.outputIndex,sourceSatoshis:e.satoshis,transactionVersion:a.version,otherInputs:a.inputs.filter((t,r)=>r!==e.inputIndex),inputIndex:e.inputIndex,outputs:a.outputs,inputSequence:a.inputs[e.inputIndex].sequence||0,subscript:e.script?c.fromHex(e.script):(new u).lock(r.toPublicKey().toAddress()),lockTime:a.lockTime,scope:e.sigHashType||s}),d=r.sign(o.sha256(i)),f=new n(d.r,d.s,e.sigHashType||s);return{sig:t.toHex(f.toChecksigFormat()),pubKey:r.toPublicKey().toString(),inputIndex:e.inputIndex,sigHashType:e.sigHashType||s,csIdx:e.csIdx}}));return Promise.resolve({sigResponses:d})}catch(t){var s;return console.error("getSignatures error",t),{error:{message:null!=(s=t.message)?s:"unknown",cause:t.cause}}}}async transfer(e,r){try{var o;const a=this.mneeConfig||await this.getConfig();if(!a)throw new Error("Config not fetched");const u=e.reduce((t,e)=>t+e.amount,0);if(u<=0)return{error:"Invalid amount"};const f=this.toAtomicAmount(u),l=d.fromWif(r),p=l.toAddress(),h=await this.getUtxos(p);if(h.reduce((t,e)=>t+(e.data.bsv21.amt||0),0)<f)return{error:"Insufficient MNEE balance"};const g=void 0!==e.find(t=>t.address===a.burnAddress)?0:null==(o=a.fees.find(t=>f>=t.min&&f<=t.max))?void 0:o.fee;if(void 0===g)return{error:"Fee ranges inadequate"};const m=new i(1,[],[],0);let w=0;const v=[];let I="";for(;w<f+g;){const t=h.shift();if(!t)return{error:"Insufficient MNEE balance"};const e=await this.fetchBeef(t.txid);if(!e)return{error:"Failed to fetch source transaction"};v.push(t.owners[0]),I=I||t.owners[0],m.addInput({sourceTXID:t.txid,sourceOutputIndex:t.vout,sourceTransaction:e,unlockingScript:new s}),w+=t.data.bsv21.amt}for(const t of e)m.addOutput(await this.createInscription(t.address,this.toAtomicAmount(t.amount),a));g>0&&m.addOutput(await this.createInscription(a.feeAddress,g,a));const x=w-f-g;x>0&&m.addOutput(await this.createInscription(I,x,a));const T=m.inputs.map((t,e)=>{var r,o;if(!t.sourceTXID)throw new Error("Source TXID is undefined");return{prevTxid:t.sourceTXID,outputIndex:t.sourceOutputIndex,inputIndex:e,address:v[e],script:null==(r=t.sourceTransaction)?void 0:r.outputs[t.sourceOutputIndex].lockingScript.toHex(),satoshis:(null==(o=t.sourceTransaction)?void 0:o.outputs[t.sourceOutputIndex].satoshis)||1,sigHashType:n.SIGHASH_ALL|n.SIGHASH_ANYONECANPAY|n.SIGHASH_FORKID}}),S=m.toHex(),y=await this.getSignatures({rawtx:S,sigRequests:T},l);if(null==y||!y.sigResponses)return{error:"Failed to get signatures"};for(const e of y.sigResponses)m.inputs[e.inputIndex].unlockingScript=(new c).writeBin(t.toArray(e.sig,"hex")).writeBin(t.toArray(e.pubKey,"hex"));const A=t.toBase64(m.toBinary()),k=await fetch(`${this.mneeApi}/v1/transfer?auth_token=${this.mneeApiToken}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rawtx:A})});if(!k.ok)throw new Error(`HTTP error! status: ${k.status}`);const{rawtx:E}=await k.json();if(!E)return{error:"Failed to broadcast transaction"};const O=t.toArray(E,"base64"),H=i.fromBinary(O);return await this.broadcast(H),{txid:H.id("hex"),rawtx:t.toHex(O)}}catch(t){let e="Transaction submission failed";return t instanceof Error&&(e=t.message,t.message.includes("HTTP error")&&console.error("HTTP error details:",t)),console.error("Failed to transfer tokens:",e),{error:e}}}async getBalance(t){try{if(!this.mneeConfig&&!await this.getConfig())throw new Error("Config not fetched");const e=(await this.getUtxos(t)).reduce((t,e)=>("transfer"===e.data.bsv21.op&&(t+=e.data.bsv21.amt),t),0);return{amount:e,decimalAmount:this.fromAtomicAmount(e)}}catch(t){return console.error("Failed to fetch balance:",t),{amount:0,decimalAmount:0}}}async validateMneeTx(e,r){try{const n=this.mneeConfig||await this.getConfig();if(!n)throw new Error("Config not fetched");const o=i.fromHex(e),s=o.outputs.map(t=>t.lockingScript),a=h(s);return r?r.forEach((e,r)=>{var s;const{address:i,amount:c}=e;if(!a.find(t=>(null==t?void 0:t.cosigner)===n.approver))throw new Error(`Cosigner not found for address: ${i} at index: ${r}`);if(!a.find(t=>(null==t?void 0:t.address)===i))throw new Error(`Address not found in script for address: ${i} at index: ${r}`);const u=p(o.outputs[r].lockingScript),d=null==u||null==(s=u.file)?void 0:s.content;if(!d)throw new Error("Invalid inscription content");const f=t.toUTF8(d);if(!f)throw new Error("Invalid inscription content");const l=JSON.parse(f);if("bsv-20"!==l.p)throw new Error(`Invalid bsv 20 protocol: ${l.p}`);if("transfer"!==l.op)throw new Error(`Invalid operation: ${l.op}`);if(l.id!==n.tokenId)throw new Error(`Invalid token id: ${l.id}`);if(l.amt!==this.toAtomicAmount(c).toString())throw new Error(`Invalid amount: ${l.amt}`)}):a.forEach(t=>{if(""!==(null==t?void 0:t.cosigner)&&(null==t?void 0:t.cosigner)!==n.approver)throw new Error("Invalid or missing cosigner")}),!0}catch(t){return console.error(t),!1}}async getMneeSyncs(t,e=0,r=100){try{const n=await fetch(`${this.mneeApi}/v1/sync?auth_token=${this.mneeApiToken}&from=${e}&limit=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([t])});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(t){return void console.error("Failed to fetch config:",t)}}async getRecentTxHistory(t,e,r){try{const n=this.mneeConfig||await this.getConfig();if(!n)throw new Error("Config not fetched");const o=await this.getMneeSyncs(t,e,r);if(!o||0===o.length)return{history:[],nextScore:e||0};const s=[];for(const e of o){const r=g(e,t,n);r&&s.push(r)}const i=s.sort((t,e)=>e.height-t.height).sort((t,e)=>"unconfirmed"===t.status?-1:1);return 0===i.length?{history:[],nextScore:e||0}:r&&i.length>r?{history:i.slice(0,r),nextScore:i[r-1].score}:{history:i,nextScore:s[s.length-1].score}}catch(t){return console.error("Failed to fetch tx history:",t),{history:[],nextScore:e||0}}}async parseTx(e){const r=this.mneeConfig||await this.getConfig();if(!r)throw new Error("Config not fetched");const n=await this.fetchBeef(e);if(!n)throw new Error("Failed to fetch transaction");const o=n.outputs.map(t=>t.lockingScript),s=n.inputs.map(t=>({txid:t.sourceTXID,vout:t.sourceOutputIndex}));let i=[],a=[],c=0n,u=0n;for(const e of s){var d;if(!e.txid)continue;const n=(await this.fetchBeef(e.txid)).outputs[e.vout],o=h([n.lockingScript])[0];if(""!==(null==o?void 0:o.cosigner)&&(null==o?void 0:o.cosigner)!==r.approver)continue;const s=p(n.lockingScript),a=null==s||null==(d=s.file)?void 0:d.content;if(!a)continue;const u=t.toUTF8(a);if(!u)continue;const f=JSON.parse(u);f&&(c+=BigInt(f.amt),i.push({address:o.address,amount:parseInt(f.amt)}))}for(const e of o){var f;const n=h([e])[0];if(""!==(null==n?void 0:n.cosigner)&&(null==n?void 0:n.cosigner)!==r.approver)continue;const o=p(e),s=null==o||null==(f=o.file)?void 0:f.content;if(!s)continue;const i=t.toUTF8(s);if(!i)continue;const c=JSON.parse(i);c&&(u+=BigInt(c.amt),a.push({address:n.address,amount:parseInt(c.amt)}))}if(r.tokenId.split("_")[0]!==e&&c!==u)throw new Error("Inputs and outputs are not equal");return{txid:e,inputs:i,outputs:a}}}class w{constructor(t){this.service=void 0,this.service=new m(t)}async validateMneeTx(t,e){return this.service.validateMneeTx(t,e)}toAtomicAmount(t){return this.service.toAtomicAmount(t)}fromAtomicAmount(t){return this.service.fromAtomicAmount(t)}async config(){return this.service.getConfig()}async balance(t){return this.service.getBalance(t)}async transfer(t,e){return this.service.transfer(t,e)}async recentTxHistory(t,e,r){return this.service.getRecentTxHistory(t,e,r)}async parseTx(t){return this.service.parseTx(t)}}export{w as default};
//# sourceMappingURL=index.modern.js.map
